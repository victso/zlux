/* ===================================================
 * zlux
 * https://zoolanders.com
 * ===================================================
 * Copyright (C) JOOlanders SL
 * http://www.gnu.org/licenses/gpl-2.0.html
 * ========================================================== */
!function(a,b,c,d,e){"use strict";function f(a){if("string"!=typeof a||""===a)return a;var b,c={t:1099511627776,g:1073741824,m:1048576,k:1024};return a=/^([0-9]+)([mgk]?)$/.exec(a.toLowerCase().replace(/[^0-9mkg]/g,"")),b=a[2],a=+a[1],c.hasOwnProperty(b)&&(a*=c[b]),a}var g=0,h={};b.component("filesManager",a.extend(!0,{},b.extensions.manager,{defaults:{root:"",extensions:"",storage:"local",storage_params:{},max_file_size:"",resize:{}},init:function(){var c=this;b.extensions.manager.init.apply(this),this.id=g++,this.options.max_file_size=f(this.options.max_file_size),this.options.extensions=this.options.extensions.replace(/\|/g,","),this.options.root=b.utils.cleanURI(this.options.root),(""===this.options.storage||this.options.storage===e||null===this.options.storage)&&(this.options.storage="local"),this.currentPath=this.options.root,this.on("resourceSelected",function(a,b){return"true"!==b.element.attr("data-zx-status")&&(b.element.attr("data-zx-status","true"),b.element.siblings().removeAttr("data-zx-status"),"folder"===b.element.data("type")&&c.goToPath(b.element.data("id"))),!1}),this.on("resourceDeleted",function(b,d){var e=h[c.currentPath].data;a.each(e,function(a,b){return d.data.name===b.name&&d.data.type===b.type?(e.splice(a,1),!1):void 0}),c.redrawInstances()}),this.DTsettings.ajax=function(a,b,d){c.ajax(a,b,d)},this.initResources()},DTsettings:{paging:!1,columns:[{title:"",data:"type",searchable:!1,"class":"zx-manager-resource-icon uk-width-1-1",render:function(a,b){return"display"===b?'<i class="uk-icon-'+("folder"===a?"folder":"file-o")+'"></i>':a}},{title:b.lang._("NAME"),data:"name","class":"zx-manager-resource-name",render:function(a,b){return"display"===b?"":a},createdCell:function(c,d,e){a(c).parent("tr").attr("data-id",b.utils.cleanURI(e.name))}}],columnDefs:{visible:!1,targets:[2]},sorting:[[0,"desc"],[1,"asc"]],serverSide:!0,rowCallback:function(c,d){var e=d;e.details=[],"folder"===d.type?e.details.push({name:b.lang._("NAME"),value:d.basename}):(e.details.push({name:b.lang._("NAME"),value:d.basename}),e.details.push({name:b.lang._("TYPE"),value:d.content_type}),e.details.push({name:b.lang._("SIZE"),value:d.size.display}));var f=b.managerResource(c,e);f.pushData(e),f.element.attr("data-type",d.type).addClass("zx-manager-resource"),a(".zx-manager-resource-name",f.element).html("").append(f.render()),a(".zx-x-name",f.element).append('<i class="zx-x-name-edit uk-icon-pencil-square" title="'+b.lang._("RENAME")+'" />')},initComplete:function(){},preDrawCallback:function(){},drawCallback:function(){}},goToPath:function(a){this._goToPath=a,this.resources.DataTable().ajax.reload(),this._goToPath=""},ajax:function(a,c){var d=this,e=b.utils.cleanURI(d.currentPath+"/"+d._goToPath);return h[e]?void c(h[e]):(a.extensions=d.options.extensions,a.root=e,"s3"===d.options.storage&&(a.storage=s3,a.accesskey=d.options.storage_params.accesskey,a.key=d.options.storage_params.secretkey,a.bucket=d.options.storage_params.bucket),void b.ajax.requestAndNotify({url:b.url.ajax("zlux","getFilesManagerData"),data:a,queue:"filesmanager"}).done(function(a){h[a.root]=a,d.cacheInited||(d.startRoot=a.root),d.currentPath=a.root,d.reloading=!1,d.cacheInited=!0,c(a)}))},redrawInstances:function(){var b=this;a("[data-zx-manager-files]").each(function(c,d){var e=a(d).data("filesManager");return e.id===b.id?!0:void(e.resources&&e.cacheInited&&e.resources.DataTable().ajax.reload())})},reload:function(){var a=this;a.reloading=!0,a.resources.DataTable().ajax.reload()},preResourceDelete:function(){},deleteObject:function(a){var b=this,c=[],d=b.getFullPath(a.name);c=b.pushStorageData(c),"s3"===b.options.storage&&"folder"===a.type&&(d+="/"),c.push({name:"path",value:d}),b.deleteObject().done(function(){h[b.sCurrentPath].data}),c.push({name:"key",value:b.options.storage_params.secretkey})},renameResource:function(c){var d=this,e=a(".zlux-x-name a",c.dom),f=e.html().match(/\.+[a-zA-Z]+$/g),g=e.html().replace(/\.+[a-zA-Z]+$/g,"");f=null!==f?f:"";var h=a("<div>"+b.lang._("INPUT_THE_NEW_NAME")+'<br /><input class="zlux-x-input" type="text" value="'+g+'" /> '+f+'<br /><span class="label label-success label-link">'+b.lang._("CONFIRM").toLowerCase()+"</span></div>").on("click",".label-link",function(){a(this).data("submited")||(a(this).data("submited",!0),a(".column-icon i",c.dom).addClass("uk-icon-spinner uk-icon-spin"),b.lang._changeObjectName(c,a("input",h).val()+f).done(function(b){e.html(b),a(".zlux-x-details-content ul li:first span",c.dom).html(b),c.dom.attr("data-id",b),c.name=b,c.basename=b.replace(/\.+[a-zA-Z]+$/g,""),c.path=c.path.replace(/(\w|[-.])+$/,b),a.zx.filesManager.aAjaxDataCache[d.sCurrentPath].aaData=d.oTable.fnGetData(),d.redrawInstances(),c.dom.removeAttr("data-zlux-object-status"),a(".zlux-x-msg",c.dom).remove()}).fail(function(a){d.pushMessageToObject(c,a)}).always(function(){a(".column-icon i",c.dom).removeClass("uk-icon-spinner uk-icon-spin")}))}).on("keypress","input",function(b){var c=b.keyCode?b.keyCode:b.which;13===c&&a(".label-link",h).trigger("click")});d.pushMessageToObject(c,h)},_changeObjectName:function(c,d){var e=this,f=[],g=e.getFullPath(c.name),h=e.getFullPath(d);return f=e.pushStorageData(f),"s3"===e.options.storage&&"folder"===c.type&&(g+="/",h+="/"),f.push({name:"src",value:g}),f.push({name:"dest",value:h}),a.Deferred(function(c){a.ajax({url:a.zx.url.ajax("zlux","moveObject"),data:f,dataType:"json",type:"post"}).done(function(a){a.result?c.resolve(a.name):c.reject(a.errors)}).fail(function(){c.reject(b.lang._("SOMETHING_WENT_WRONG"))})}).promise()},pushStorageData:function(a){var b=this;return"s3"===b.options.storage&&(a.push({name:"storage",value:"s3"}),a.push({name:"accesskey",value:b.options.storage_params.accesskey}),a.push({name:"key",value:b.options.storage_params.secretkey}),a.push({name:"bucket",value:b.options.storage_params.bucket})),a},getFullPath:function(a){var b=this.sCurrentPath;return b?b+"/"+a:a}})),a.UIkit.ready(function(c){a("[data-zx-manager-files]",c).each(function(){var c=a(this);if(!c.data("filesManager")){b.filesManager(c,a.UIkit.Utils.options(c.attr("data-zx-manager-files")))}})})}(jQuery,jQuery.zx,window,document);