/**
 * @package     zlux
 * @version     2.0.3
 * @author      ZOOlanders - http://zoolanders.com
 * @license     GNU General Public License v2 or later
 */

!function(e,a,t){"use strict";function n(e){if("string"!=typeof e||""===e)return e;var a,t={t:1099511627776,g:1073741824,m:1048576,k:1024};return e=/^([0-9]+)([mgk]?)$/.exec(e.toLowerCase().replace(/[^0-9mkg]/g,"")),a=e[2],e=+e[1],t.hasOwnProperty(a)&&(e*=t[a]),e}var s=0,o={};a.component("filesManager",e.extend(!0,{},a.extensions.manager,{defaults:{root:"",extensions:"",storage:"local",storage_params:{},max_file_size:"",resize:{}},init:function(){var t=this;a.extensions.manager.init.apply(this),this.id=s++,this.options.max_file_size=n(this.options.max_file_size),this.options.extensions=this.options.extensions.replace(/\|/g,","),this.options.root=a.url.clean(this.options.root),""!==this.options.storage&&void 0!==this.options.storage&&null!==this.options.storage||(this.options.storage="local"),this.currentPath=this.options.root,this.on("resourceSelected",function(e,a){return"true"!==a.element.attr("data-zx-status")&&(a.element.attr("data-zx-status","true"),a.element.siblings().removeAttr("data-zx-status"),"folder"===a.element.data("type")&&t.goToPath(a.element.data("id"))),!1}),this.on("resourceDeleted",function(a,n){var s=o[t.currentPath].data;e.each(s,function(e,a){return n.data.name===a.name&&n.data.type===a.type?(s.splice(e,1),!1):void 0}),t.redrawInstances()}),this.DTsettings.ajax=function(e,a,n){t.ajax(e,a,n)},this.initResources()},DTsettings:{paging:!1,columns:[{title:"",data:"type",searchable:!1,"class":"zx-manager-resource-icon uk-width-1-1",render:function(e,a){return"display"===a?'<i class="uk-icon-'+("folder"===e?"folder":"file-o")+'"></i>':e}},{title:a.lang._("NAME"),data:"name","class":"zx-manager-resource-name",render:function(e,a){return"display"===a?"":e},createdCell:function(t,n,s){e(t).parent("tr").attr("data-id",a.url.clean(s.name))}}],columnDefs:{visible:!1,targets:[2]},sorting:[[0,"desc"],[1,"asc"]],serverSide:!0,rowCallback:function(t,n){var s=n;s.details=[],"folder"===n.type?s.details.push({name:a.lang._("NAME"),value:n.basename}):(s.details.push({name:a.lang._("NAME"),value:n.basename}),s.details.push({name:a.lang._("TYPE"),value:n.content_type}),s.details.push({name:a.lang._("SIZE"),value:n.size.display}));var o=a.managerResource(t,s);o.pushData(s),o.element.attr("data-type",n.type).addClass("zx-manager-resource"),e(".zx-manager-resource-name",o.element).html("").append(o.render()),e(".zx-x-name",o.element).append('<i class="zx-x-name-edit uk-icon-pencil-square" title="'+a.lang._("RENAME")+'" />')},initComplete:function(){},preDrawCallback:function(){},drawCallback:function(e){}},goToPath:function(e){this._goToPath=e,this.resources.DataTable().ajax.reload(),this._goToPath=""},ajax:function(e,t,n){var s=this,r=a.url.clean(s.currentPath+"/"+s._goToPath);return o[r]?void t(o[r]):(e.extensions=s.options.extensions,e.root=r,"s3"===s.options.storage&&(e.storage=s3,e.accesskey=s.options.storage_params.accesskey,e.key=s.options.storage_params.secretkey,e.bucket=s.options.storage_params.bucket),void a.ajax.requestAndNotify({url:a.url.get("ajax:",{controller:"zlux",task:"getFilesManagerData"}),data:e,queue:"filesmanager"}).done(function(e){o[e.root]=e,s.cacheInited||(s.startRoot=e.root),s.currentPath=e.root,s.reloading=!1,s.cacheInited=!0,t(e)}))},redrawInstances:function(){var a=this;e("[data-zx-manager-files]").each(function(t,n){var s=e(n).data("filesManager");return s.id===a.id?!0:void(s.resources&&s.cacheInited&&s.resources.DataTable().ajax.reload())})},reload:function(){var e=this;e.reloading=!0,e.resources.DataTable().ajax.reload()},preResourceDelete:function(e,a){},deleteObject:function(e){var a=this,t=[],n=a.getFullPath(e.name);t=a.pushStorageData(t),"s3"===a.options.storage&&"folder"===e.type&&(n+="/"),t.push({name:"path",value:n}),a.deleteObject().done(function(e){o[a.sCurrentPath].data}),t.push({name:"key",value:a.options.storage_params.secretkey})},renameResource:function(t){var n=this,s=e(".zlux-x-name a",t.dom),o=s.html().match(/\.+[a-zA-Z]+$/g),r=s.html().replace(/\.+[a-zA-Z]+$/g,"");o=null!==o?o:"";var i=e("<div>"+a.lang._("INPUT_THE_NEW_NAME")+'<br /><input class="zlux-x-input" type="text" value="'+r+'" /> '+o+'<br /><span class="label label-success label-link">'+a.lang._("CONFIRM").toLowerCase()+"</span></div>").on("click",".label-link",function(){e(this).data("submited")||(e(this).data("submited",!0),e(".column-icon i",t.dom).addClass("uk-icon-spinner uk-icon-spin"),a.lang._changeObjectName(t,e("input",i).val()+o).done(function(a){s.html(a),e(".zlux-x-details-content ul li:first span",t.dom).html(a),t.dom.attr("data-id",a),t.name=a,t.basename=a.replace(/\.+[a-zA-Z]+$/g,""),t.path=t.path.replace(/(\w|[-.])+$/,a),e.zx.filesManager.aAjaxDataCache[n.sCurrentPath].aaData=n.oTable.fnGetData(),n.redrawInstances(),t.dom.removeAttr("data-zlux-object-status"),e(".zlux-x-msg",t.dom).remove()}).fail(function(e){n.pushMessageToObject(t,e)}).always(function(){e(".column-icon i",t.dom).removeClass("uk-icon-spinner uk-icon-spin")}))}).on("keypress","input",function(a){var t=a.keyCode?a.keyCode:a.which;13===t&&e(".label-link",i).trigger("click")});n.pushMessageToObject(t,i)},_changeObjectName:function(t,n){var s=this,o=[],r=s.getFullPath(t.name),i=s.getFullPath(n);return o=s.pushStorageData(o),"s3"===s.options.storage&&"folder"===t.type&&(r+="/",i+="/"),o.push({name:"src",value:r}),o.push({name:"dest",value:i}),e.Deferred(function(t){e.ajax({url:e.zx.url.ajax("zlux","moveObject"),data:o,dataType:"json",type:"post"}).done(function(e){e.result?t.resolve(e.name):t.reject(e.errors)}).fail(function(){t.reject(a.lang._("SOMETHING_WENT_WRONG"))})}).promise()},pushStorageData:function(e){var a=this;return"s3"===a.options.storage&&(e.push({name:"storage",value:"s3"}),e.push({name:"accesskey",value:a.options.storage_params.accesskey}),e.push({name:"key",value:a.options.storage_params.secretkey}),e.push({name:"bucket",value:a.options.storage_params.bucket})),e},getFullPath:function(e){var a=this.sCurrentPath;return a?a+"/"+e:e}})),e.UIkit.ready(function(t){e("[data-zx-manager-files]",t).each(function(){var t=e(this);if(!t.data("filesManager")){a.filesManager(t,e.UIkit.Utils.options(t.attr("data-zx-manager-files")))}})})}(jQuery,zlux,UIkit);